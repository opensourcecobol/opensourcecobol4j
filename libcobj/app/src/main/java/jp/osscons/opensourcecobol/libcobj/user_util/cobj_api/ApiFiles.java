/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package jp.osscons.opensourcecobol.libcobj.user_util.cobj_api;

import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.nio.file.Files;
import java.nio.file.Paths;
import org.json.JSONArray;
import org.json.JSONObject;

/** TODO: 準備中 */
public class ApiFiles {
  /**
   * TODO: 準備中
   *
   * @param args TODO: 準備中
   */
  public static void main(String[] args) {
    ApiFilesOptions.getOptions(args);

    if (args.length == 0) {
      System.out.println("No json file is specified.");
      System.exit(1);
    }

    String filePath;
    try {
      filePath = args[1];
    } catch (ArrayIndexOutOfBoundsException e) {
      filePath = args[0];
    }

    javaCreate(filePath);
  }

  /**
   * TODO: 準備中
   *
   * @param filePath TODO: 準備中
   */
  public static void javaCreate(String filePath) {
    try {
      String json = new String(Files.readAllBytes(Paths.get(filePath)));
      JSONObject obj = new JSONObject(json);
      String programId = obj.getString("program_id");
      JSONArray params = obj.getJSONArray("procedure_division_using_parameters");

      String outputDir;
      FileWriter ctlFile;
      FileWriter rcdFile;

      if (ApiFilesOptions.outputDir != null) {
        outputDir = ApiFilesOptions.outputDir + "/";
        ctlFile = new FileWriter(outputDir + programId + "Controller.java");
        rcdFile = new FileWriter(outputDir + programId + "Record.java");
      } else {
        ctlFile = new FileWriter(programId + "Controller.java");
        rcdFile = new FileWriter(programId + "Record.java");
      }

      writeController(ctlFile, programId, params);
      writeRecord(rcdFile, programId, params);

    } catch (IOException e) {
      e.printStackTrace();
      System.err.println("Error reading file: " + e.getMessage());
      System.exit(1);
    }
  }

  /**
   * TODO: 準備中
   *
   * @param ctlFile TODO: 準備中
   * @param programId TODO: 準備中
   * @param params TODO: 準備中
   */
  public static void writeController(FileWriter ctlFile, String programId, JSONArray params) {
    PrintWriter ctlWriter = new PrintWriter(ctlFile);
    JSONObject param;
    String name;
    String type;
    String defaultValue;
    String methodName;
    String nameController = programId + "Controller";
    String nameRecord = programId + "Record";
    int i;

    if (ApiFilesOptions.packageName != null) {
      ctlWriter.println("package " + ApiFilesOptions.packageName + ";");
    } else {
      ctlWriter.println("package com.example.restservice;");
    }

    ctlWriter.println(
        "import java.util.concurrent.atomic.AtomicLong;\n"
            + "import org.springframework.web.bind.annotation.GetMapping;\n"
            + "import org.springframework.web.bind.annotation.RequestParam;\n"
            + "import org.springframework.web.bind.annotation.RestController;\n"
            + "import jp.osscons.opensourcecobol.libcobj.ui.*;\n");

    ctlWriter.println(
        "@RestController\n"
            + "public class "
            + nameController
            + " {\n"
            + "    @GetMapping(\"/"
            + programId
            + "\")\n"
            + "    public "
            + nameRecord
            + " "
            + nameController
            + "(");

    for (i = 0; i < params.length(); ++i) {
      param = params.getJSONObject(i);
      name = param.getString("variable_name").replace('-', '_');
      type = param.getString("java_type");
      if ("String".equals(type)) {
        defaultValue = "\"\"";
      } else {
        defaultValue = "\"0\"";
      }

      ctlWriter.print(
          "        @RequestParam(value = "
              + "\""
              + name
              + "\", defaultValue = "
              + defaultValue
              + ") "
              + type
              + " "
              + name);

      if (i < params.length() - 1) {
        ctlWriter.println(",");
      } else {
        ctlWriter.println();
      }
    }

    ctlWriter.print(
        "    ) {\n"
            + "        int statuscode = 200;\n"
            + "        "
            + programId
            + " "
            + programId
            + "Cobol = new "
            + programId
            + "();\n"
            + "        CobolResultSet result = "
            + programId
            + "Cobol.execute(");

    for (i = 0; i < params.length(); ++i) {
      param = params.getJSONObject(i);
      name = param.getString("variable_name").replace('-', '_');
      ctlWriter.print(name);

      if (i < params.length() - 1) {
        ctlWriter.print(", ");
      }
    }
    ctlWriter.println(");\n" + "        try {");

    for (i = 0; i < params.length(); ++i) {
      param = params.getJSONObject(i);
      name = param.getString("variable_name").replace('-', '_');
      type = param.getString("java_type");
      if ("String".equals(type)) {
        methodName = "getString";
      } else if ("int".equals(type)) {
        methodName = "getInt";
      } else {
        methodName = "getDouble";
      }
      ctlWriter.println("            " + name + " = result." + methodName + "(" + (i + 1) + ");");
    }

    ctlWriter.print(
        "        } catch (Exception e) {\n"
            + "            statuscode = 500;\n"
            + "        }\n"
            + "        return new "
            + programId
            + "Record(statuscode, ");

    for (i = 0; i < params.length(); ++i) {
      param = params.getJSONObject(i);
      name = param.getString("variable_name").replace('-', '_');
      ctlWriter.print(name);
      if (i < params.length() - 1) {
        ctlWriter.print(", ");
      }
    }
    ctlWriter.println(");\n" + "    }\n" + "}");
    ctlWriter.close();
  }

  /**
   * TODO: 準備中
   *
   * @param rcdFile TODO: 準備中
   * @param programId TODO: 準備中
   * @param params TODO: 準備中
   */
  public static void writeRecord(FileWriter rcdFile, String programId, JSONArray params) {
    PrintWriter rcdWriter = new PrintWriter(rcdFile);
    JSONObject param;
    String name;
    String type;
    int i;

    rcdWriter.print(
        "package com.example.restservice;\n"
            + "public record "
            + programId
            + "Record(int statuscode, ");

    for (i = 0; i < params.length(); ++i) {
      param = params.getJSONObject(i);
      name = param.getString("variable_name").replace('-', '_');
      type = param.getString("java_type");
      rcdWriter.print(type + " " + name);
      if (i < params.length() - 1) {
        rcdWriter.print(", ");
      }
    }
    rcdWriter.println(") {}");
    rcdWriter.close();
  }
}
